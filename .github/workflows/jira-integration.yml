name: Jira PR Automation

on:
  pull_request:
    types: [opened, reopened, labeled, unlabeled, synchronize, edited]
  pull_request_target:
    types: [opened, reopened, labeled, unlabeled]

permissions:
  pull-requests: write
  contents: write
  issues: write
  statuses: write

jobs:
  jira-integration:
    runs-on: ubuntu-latest

    steps:
      - name: Extract Jira ID from Multiple Sources
        id: extract-jira
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const labels = pr.labels.map(l => l.name);
            console.log('PR #:', pr.number, pr.title, pr.head.ref, labels);

            const jiraLabel = labels.find(l => /^(jira\/)?[A-Z]{2,10}-\d+$/i.test(l));
            if (jiraLabel) {
              const key = jiraLabel.replace(/^jira\//, '').toUpperCase();
              core.setOutput('jira_key', key);
              core.setOutput('has_jira', 'true');
              core.setOutput('source', 'label');
              return;
            }

            const branchMatch = pr.head.ref.match(/[A-Z]{2,10}-\d+/i);
            if (branchMatch) {
              const key = branchMatch[0].toUpperCase();
              core.setOutput('jira_key', key);
              core.setOutput('has_jira', 'true');
              core.setOutput('source', 'branch');
              return;
            }

            const titleMatch = pr.title.match(/[A-Z]{2,10}-\d+/i);
            if (titleMatch) {
              const key = titleMatch[0].toUpperCase();
              core.setOutput('jira_key', key);
              core.setOutput('has_jira', 'true');
              core.setOutput('source', 'title');
              return;
            }

            core.setOutput('has_jira', 'false');

      - name: Post Missing Jira Warning
        if: steps.extract-jira.outputs.has_jira != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const botSignature = '<!-- jira-bot-warning -->';
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes(botSignature));

            const msg = `## ‚ö†Ô∏è Missing Jira Ticket Link

This PR is not linked to a Jira ticket. Please link it using one of these methods:

### üè∑Ô∏è Method 1: Add a Label (Recommended)
1. Click **"Labels"** in the right sidebar ‚Üí
2. Search for your Jira ticket (e.g., \`SCRUM-123\`)
3. Select it

### üåø Method 2: Include in Branch Name
Use branch name like: \`feature/SCRUM-123-description\`

### üìù Method 3: Include in PR Title
Format: \`[SCRUM-123] Your PR title\`

---

**Why is this required?**
- Ensures traceability between code and requirements  
- Enables automated context for code reviews  
- Required for compliance and audits  

Once linked, Jira story details will be automatically fetched and posted here.

${botSignature}`;

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: msg
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: msg
              });
            }

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'failure',
              context: 'Jira Integration',
              description: 'Jira ticket link required'
            });

      - name: Fetch Jira Story Details
        id: fetch-jira
        if: steps.extract-jira.outputs.has_jira == 'true'
        run: |
          JIRA_KEY="${{ steps.extract-jira.outputs.jira_key }}"
          echo "üîç Fetching Jira details for: $JIRA_KEY"
          # ... curl & jq logic kept unchanged ...

      - name: Auto-Generate PR Title
        if: steps.extract-jira.outputs.has_jira == 'true' && steps.fetch-jira.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const jiraKey = '${{ steps.extract-jira.outputs.jira_key }}';
            const summary = `${{ steps.fetch-jira.outputs.summary }}`;
            const issueType = '${{ steps.fetch-jira.outputs.issue_type }}';
            const prTitle = context.payload.pull_request.title;

            const needsUpdate =
              !prTitle.includes(jiraKey) ||
              prTitle.toLowerCase().includes('update') ||
              prTitle.toLowerCase().includes('initial commit');

            if (needsUpdate) {
              const typeMap = {
                Story: 'feat',
                Bug: 'fix',
                Task: 'chore',
                Epic: 'feat',
                'Sub-task': 'chore'
              };
              const prefix = typeMap[issueType] || 'feat';
              const newTitle = `${prefix}: [${jiraKey}] ${summary}`;
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                title: newTitle
              });
            }

      - name: Post Comprehensive Jira Context
        if: steps.extract-jira.outputs.has_jira == 'true' && steps.fetch-jira.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const jiraKey = '${{ steps.extract-jira.outputs.jira_key }}';
            const jiraUrl = '${{ secrets.JIRA_BASE_URL }}/browse/' + jiraKey;
            const summary = `${{ steps.fetch-jira.outputs.summary }}`;
            const description = `${{ steps.fetch-jira.outputs.description }}`;
            const acceptance = `${{ steps.fetch-jira.outputs.acceptance_criteria }}`;
            const issueType = '${{ steps.fetch-jira.outputs.issue_type }}';
            const status = '${{ steps.fetch-jira.outputs.status }}';
            const priority = '${{ steps.fetch-jira.outputs.priority }}';
            const assignee = '${{ steps.fetch-jira.outputs.assignee }}';
            const source = '${{ steps.extract-jira.outputs.source }}';
            const botSignature = '<!-- jira-context-comment -->';

            let reviewFocus = '';
            switch (issueType) {
              case 'Bug':
                reviewFocus = `**Bug Fix Review Focus:**
- Root cause verified  
- Regression tested  
- Minimal impact`;
                break;
              case 'Story':
              case 'Task':
                reviewFocus = `**Feature Review Focus:**
- Acceptance criteria met  
- UX intuitive  
- Performance validated`;
                break;
              default:
                reviewFocus = `**General Review Focus:**  
- Requirements met  
- Tests adequate`;
            }

            const commentBody = `## ü§ñ Automated Jira Context

${botSignature}

**Linked Ticket:** [${jiraKey}](${jiraUrl})

| Field | Value |
|-------|-------|
| **Summary** | ${summary} |
| **Type** | ${issueType} |
| **Status** | \`${status}\` |
| **Priority** | ${priority} |
| **Assignee** | ${assignee} |

---

### Description
${description}

### ‚úÖ Acceptance Criteria
${acceptance}

---

${reviewFocus}

---

<sub>Linked via ${source} ‚Ä¢ Auto-generated by Jira Integration</sub>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const existing = comments.find(
              c => c.user.type === 'Bot' && c.body.includes(botSignature)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentBody
              });
            }

      - name: Create Success Status Check
        if: steps.extract-jira.outputs.has_jira == 'true' && steps.fetch-jira.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const jiraKey = '${{ steps.extract-jira.outputs.jira_key }}';
            const jiraUrl = '${{ secrets.JIRA_BASE_URL }}/browse/' + jiraKey;
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'success',
              context: 'Jira Integration',
              description: `Linked to ${jiraKey}`,
              target_url: jiraUrl
            });

      - name: Auto-Request Review from Jira Assignee
        if: steps.extract-jira.outputs.has_jira == 'true' && steps.fetch-jira.outcome == 'success'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const email = '${{ steps.fetch-jira.outputs.assignee_email }}';
            if (!email) return console.log('‚ÑπÔ∏è No Jira assignee email found');

            const { data } = await github.rest.search.users({ q: `${email} in:email` });
            if (data.total_count > 0) {
              const reviewer = data.items[0].login;
              if (reviewer !== context.payload.pull_request.user.login) {
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.payload.pull_request.number,
                  reviewers: [reviewer]
                });
                console.log(`‚úÖ Requested review from: ${reviewer}`);
              }
            }

      - name: Handle Jira Fetch Failure
        if: failure() && steps.extract-jira.outputs.has_jira == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const jiraKey = '${{ steps.extract-jira.outputs.jira_key }}';
            const jiraUrl = '${{ secrets.JIRA_BASE_URL }}/browse/' + jiraKey;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ‚ùå Jira Integration Error

Unable to fetch details for [${jiraKey}](${jiraUrl}).

**Possible Causes:**
- Ticket doesn't exist  
- API credentials invalid  
- Network error  

<sub>${new Date().toISOString()}</sub>`
            });
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'error',
              context: 'Jira Integration',
              description: `Failed to fetch ${jiraKey}`
            });

      - name: Delete PR Template if Exists
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('‚ÑπÔ∏è Reminder: Remove .github/pull_request_template.md if auto-generation is used.');
