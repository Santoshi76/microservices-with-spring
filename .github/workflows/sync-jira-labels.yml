name: Sync Jira Tickets as Labels

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 6 hours
  workflow_dispatch:

permissions:
  issues: write

jobs:
  sync-labels:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch Active Jira Tickets
        id: fetch-jira
        run: |
          # Fetch all tickets in current sprint or specific status
          RESPONSE=$(curl -s -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/search?jql=project=SCRUM AND status!=Done AND status!=Closed&fields=key,summary&maxResults=100")
          
          echo "==== RESPONSE ===="
          echo "$RESPONSE"
          echo "=================="

          echo "$RESPONSE" | jq -r '.issues[] | "\(.key)|\(.fields.summary)"' > jira_tickets.txt
          cat jq_error.log || true
          cat jira_tickets.txt || true


      - name: Create/Update GitHub Labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const tickets = fs.readFileSync('jira_tickets.txt', 'utf8')
              .split('\n')
              .filter(line => line.trim())
              .map(line => {
                const [key, summary] = line.split('|');
                return { key, summary };
              });
            
            console.log(`Found ${tickets.length} active Jira tickets`);
            
            // Get existing labels
            const { data: existingLabels } = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const existingLabelNames = new Set(existingLabels.map(l => l.name));
            
            // Create missing labels
            for (const ticket of tickets) {
              if (!existingLabelNames.has(ticket.key)) {
                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: ticket.key,
                    color: '0052CC',  // Jira blue
                    description: ticket.summary.substring(0, 100)  // Max 100 chars
                  });
                  console.log(`✅ Created label: ${ticket.key}`);
                } catch (error) {
                  console.log(`⚠️ Could not create ${ticket.key}: ${error.message}`);
                }
              }
            }
