name: Fetch Jira Story Details

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  fetch-jira-details:
    runs-on: ubuntu-latest

    steps:
      - name: Extract Jira Issue Key
        id: jira-key
        run: |
          # Extract from PR title, branch name, or description
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          
          # Try to extract Jira key (format: PROJ-123)
          JIRA_KEY=$(echo "$PR_TITLE $PR_BRANCH" | grep -oE '[A-Z]+-[0-9]+' | head -1)
          
          if [ -z "$JIRA_KEY" ]; then
            echo "No Jira key found"
            exit 0
          fi
          
          echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT
          echo "Found Jira key: $JIRA_KEY"

      - name: Fetch Jira Story Details
        id: jira-details
        if: steps.jira-key.outputs.jira_key != ''
        run: |
          JIRA_KEY="${{ steps.jira-key.outputs.jira_key }}"
          
          # Fetch from Jira API
          RESPONSE=$(curl -s -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/$JIRA_KEY?fields=summary,description,customfield_10039")
          
          # Extract fields ( customfield_10039 is acceptance criteria field)
          SUMMARY=$(echo "$RESPONSE" | jq -r '.fields.summary // "N/A"')
          DESCRIPTION=$(echo "$RESPONSE" | jq -r '.fields.description.content[0].content[0].text // "N/A"')
          
          # Save to environment file
          echo "JIRA_SUMMARY=$SUMMARY" >> $GITHUB_ENV
          echo "JIRA_DESCRIPTION=$DESCRIPTION" >> $GITHUB_ENV

      - name: Comment on PR with Jira Details
        if: steps.jira-key.outputs.jira_key != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const jiraKey = '${{ steps.jira-key.outputs.jira_key }}';
            const jiraUrl = '${{ secrets.JIRA_BASE_URL }}/browse/' + jiraKey;
            
            const comment = `## ðŸ“‹ Jira Story Details
            
            **Story:** [${jiraKey}](${jiraUrl})
            **Summary:** ${{ env.JIRA_SUMMARY }}
            
            ### Description
            ${{ env.JIRA_DESCRIPTION }}
            
            ### Acceptance Criteria
            ${{ env.JIRA_ACCEPTANCE_CRITERIA }}
            
            ---
            *This information is provided for GitHub Copilot code review context.*`;
            
            // Check if comment already exists
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Jira Story Details')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }